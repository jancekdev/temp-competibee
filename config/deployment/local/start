#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset
# TODO: remove afrter this is working
# sync_python_dependencies() {
#   local lock_hash current_hash_file="/app/.venv/.uv-lock-hash"
#   lock_hash=$(sha256sum /app/uv.lock | awk '{print $1}')
#   if [ ! -f "${current_hash_file}" ] || [ "${lock_hash}" != "$(cat "${current_hash_file}")" ]; then
#     echo "Syncing Python dependencies with uv..."
#     (cd /app && uv sync --frozen --all-groups)
#     echo "${lock_hash}" > "${current_hash_file}"
#   fi
# }

# sync_python_dependencies

python - <<'PY'
import os
import socket
import time
from urllib.parse import urlparse

url = os.environ.get("DATABASE_URL")
if not url:
    raise SystemExit("DATABASE_URL is not set; cannot wait for database")

parsed = urlparse(url)
host = parsed.hostname or "localhost"
port = parsed.port or 5432

attempts = 30
for attempt in range(1, attempts + 1):
    try:
        with socket.create_connection((host, port), timeout=3):
            print(f"[django] Database is available (attempt {attempt})")
            raise SystemExit(0)
    except OSError as exc:
        print(f"[django] Waiting for database (attempt {attempt}/{attempts}): {exc}")
        time.sleep(2)

raise SystemExit("Database was not reachable in time")
PY

python manage.py migrate --fake-initial
exec python manage.py runserver 0.0.0.0:8000
